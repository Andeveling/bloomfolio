---
import { ArrowRight, ChevronLeft } from "@lucide/astro";
import { Image } from "astro:assets";
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import { compareDesc, formatDate, toISODateTime } from "../../utils/formats";

const blogPosts = await getCollection("blog");

// Sort by publish date, most recent first (using date-fns for safety)
const sortedPosts = blogPosts.sort((a, b) =>
  compareDesc(
    typeof a.data.publishDate === "string"
      ? new Date(a.data.publishDate)
      : a.data.publishDate,
    typeof b.data.publishDate === "string"
      ? new Date(b.data.publishDate)
      : b.data.publishDate
  )
);

// Get unique tags from all posts for filters
const allTags = [...new Set(blogPosts.flatMap((post) => post.data.tags || []))];
const displayTags = allTags.slice(0, 5);

// ...now using format utilities from src/utils/formats.ts

function getFirstTag(tags?: string[]) {
  return tags && tags.length > 0 ? tags[0].toUpperCase() : "BLOG";
}
---

<Layout
  title="Blog - Andres Parra"
  description="Lee mis pensamientos, historias e ideas sobre desarrollo, diseño y tecnología."
>
  <main class="max-w-6xl mx-auto px-4 py-20">
    <!-- Header -->
    <div class="text-center mb-12">
      <h1 class="text-5xl font-bold mb-4">Blog</h1>
      <p class="text-xl text-base-content/70">
        Lee mis pensamientos, historias e ideas sobre desarrollo, diseño y
        tecnología.
      </p>
    </div>

    <!-- Back to Home -->
    <div class="mb-8">
      <a href="/" class="btn btn-ghost btn-sm gap-1">
        <ChevronLeft class="size-5" />
        Volver
      </a>
    </div>

    <!-- Main Layout: Sidebar + Posts -->
    {
      sortedPosts.length === 0 ? (
        <div class="text-center py-20">
          <p class="text-2xl text-base-content/60">
            No hay publicaciones en el blog todavía. ¡Vuelve pronto!
          </p>
        </div>
      ) : (
        <div class="flex flex-col lg:flex-row gap-8">
          {/* Sidebar */}
          <aside class="lg:w-64 shrink-0">
            {/* Quick Filters */}
            <div class="mb-8">
              <h3 class="font-semibold text-base-content mb-4">Filtros :</h3>
              <div class="flex flex-col gap-3">
                {displayTags.map((tag, index) => (
                  <label class="flex items-center gap-3 cursor-pointer group">
                    <input
                      type="checkbox"
                      class="checkbox checkbox-sm checkbox-primary"
                      data-filter-tag={tag}
                    />
                    <span class="text-sm text-base-content/80 group-hover:text-primary transition-colors">
                      {tag}
                    </span>
                  </label>
                ))}
              </div>
            </div>
          </aside>

          {/* Blog Posts List */}
          <div class="flex-1 space-y-6">
            {sortedPosts.map((post) => (
              <article
                class="blog-card group flex flex-col sm:flex-row gap-6 p-4 bg-base-100 rounded-box border border-base-300 hover:border-primary/30 hover:shadow-lg transition-all"
                data-tags={JSON.stringify(post.data.tags || [])}
              >
                {/* Image */}
                <a
                  href={`/blog/${post.id}`}
                  class="sm:w-40 sm:h-32 shrink-0 overflow-hidden rounded-lg block"
                >
                  <Image
                    src={post.data.image}
                    alt={post.data.title}
                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                    width={160}
                    height={128}
                    transition:name={`blog-image-${post.id}`}
                  />
                </a>

                {/* Content */}
                <div class="flex-1 flex flex-col justify-between">
                  {/* Top: Category + Date */}
                  <div class="flex items-center justify-between gap-4 mb-2">
                    <span
                      class="text-xs font-semibold tracking-wider text-base-content/60 uppercase"
                      transition:name={`blog-category-${post.id}`}
                    >
                      {getFirstTag(post.data.tags)}
                    </span>
                    <time
                      class="text-xs text-base-content/50"
                      datetime={toISODateTime(post.data.publishDate)}
                      transition:name={`blog-date-${post.id}`}
                    >
                      {formatDate(post.data.publishDate)}
                    </time>
                  </div>

                  {/* Title */}
                  <h2
                    class="text-lg font-bold text-base-content group-hover:text-primary transition-colors mb-2"
                    transition:name={`blog-title-${post.id}`}
                  >
                    <a href={`/blog/${post.id}`}>{post.data.title}</a>
                  </h2>

                  {/* Description */}
                  <p
                    class="text-sm text-base-content/70 line-clamp-2 mb-3"
                    transition:name={`blog-description-${post.id}`}
                  >
                    {post.data.description}
                  </p>

                  {/* Read More Link */}
                  <div class="flex justify-end">
                    <a
                      href={`/blog/${post.id}`}
                      class="text-sm font-medium text-primary hover:underline inline-flex items-center gap-1 transition-colors"
                    >
                      Leer más
                      <ArrowRight class="size-3" />
                    </a>
                  </div>
                </div>
              </article>
            ))}
          </div>
        </div>
      )
    }
  </main>
</Layout>

<script>
  // Simple filter functionality
  document.addEventListener("DOMContentLoaded", () => {
    const checkboxes = document.querySelectorAll("[data-filter-tag]");
    const articles = document.querySelectorAll("[data-tags]");

    checkboxes.forEach((checkbox) => {
      checkbox.addEventListener("change", () => {
        const activeFilters = Array.from(checkboxes)
          .filter((cb) => (cb as HTMLInputElement).checked)
          .map((cb) => cb.getAttribute("data-filter-tag"));

        articles.forEach((article) => {
          const tags = JSON.parse(
            article.getAttribute("data-tags") || "[]"
          ) as string[];

          if (activeFilters.length === 0) {
            (article as HTMLElement).style.display = "";
          } else {
            const hasMatch = activeFilters.some((filter) =>
              tags.includes(filter as string)
            );
            (article as HTMLElement).style.display = hasMatch ? "" : "none";
          }
        });
      });
    });
  });
</script>
